//========add start========
import { FocusRecordDao } from './database';
import { FocusRecord } from './Entities/RecordOFocus';
//========add end========

@Component
export struct Analyse{
  pathInfos:   NavPathStack=new NavPathStack();
  name: string='';
  userID: number=0;

  //========add start========
  normalBGColor: string='#018f8f';
  todayBGColor: string='#32bdc0';

  @State totalDuration: number = 0;          // æ€»ä¸“æ³¨æ—¶é•¿ï¼ˆç§’ï¼‰
  @State todayFocusCount: number = 0;        // ä»Šæ—¥ä¸“æ³¨æ¬¡æ•°
  @State totalFocusCount: number = 0;        // æ€»ä¸“æ³¨æ¬¡æ•°
  @State completedCount: number = 0;         // å®Œæˆæ¬¡æ•°
  @State uncompletedCount:  number = 0;       // æœªå®Œæˆæ¬¡æ•°
  @State completionRate: number = 0;         // å®Œæˆç‡
  @State averageDuration: number = 0;        // å¹³å‡ä¸“æ³¨æ—¶é•¿ï¼ˆç§’ï¼‰
  @State longestDuration: number = 0;        // æœ€é•¿ä¸“æ³¨æ—¶é•¿ï¼ˆç§’ï¼‰
  @State recentRecords: FocusRecord[] = [];  // æœ€è¿‘çš„ä¸“æ³¨è®°å½•

  // æ ¼å¼åŒ–æ—¶é•¿ä¸ºå¯è¯»å­—ç¬¦ä¸²
  formatDuration(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) {
      return `${hours}å°æ—¶${minutes}åˆ†${secs}ç§’`;
    } else if (minutes > 0) {
      return `${minutes}åˆ†${secs}ç§’`;
    } else {
      return `${secs}ç§’`;
    }
  }

  // æ ¼å¼åŒ–æ—¶é•¿ä¸ºç®€çŸ­å­—ç¬¦ä¸²ï¼ˆç”¨äºå¤§æ•°å­—æ˜¾ç¤ºï¼‰
  formatDurationShort(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    if (hours > 0) {
      return `${hours}h ${minutes}m`;
    } else if (minutes > 0) {
      return `${minutes}m`;
    } else {
      return `${seconds}s`;
    }
  }

  // åŠ è½½ç»Ÿè®¡æ•°æ®
  // åŠ è½½ç»Ÿè®¡æ•°æ®
  async loadStatistics() {
    try {
      console.log(`å¼€å§‹åŠ è½½ç”¨æˆ·${this.userID}çš„ç»Ÿè®¡æ•°æ®`);

      // 1. è·å–æ‰€æœ‰è®°å½•è¿›è¡Œç»Ÿè®¡ï¼ˆå…ˆè·å–å…¨éƒ¨æ•°æ®ï¼‰
      const allRecords = await FocusRecordDao.getFocusRecordByUserId(this.userID);
      console.log(`è·å–åˆ°${allRecords.length}æ¡è®°å½•`);
      console.log(`allRecords length:${allRecords.length}`);

      //========ä¿®æ”¹ start========
      // å…ˆé‡ç½®æ‰€æœ‰çŠ¶æ€ä¸º0ï¼Œç¡®ä¿æ¸…ç©ºæ—§æ•°æ®
      this.totalFocusCount = 0;
      this.completedCount = 0;
      this.uncompletedCount = 0;
      this.completionRate = 0;
      this.totalDuration = 0;
      this.averageDuration = 0;
      this.longestDuration = 0;
      this.todayFocusCount = 0;
      this.recentRecords = [];

      // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œç›´æ¥è¿”å›
      if (allRecords. length === 0) {
        console.log('æ²¡æœ‰ä»»ä½•è®°å½•');
        return;
      }

      // 2. ç»Ÿè®¡æ€»æ¬¡æ•°ï¼ˆè§¦å‘çŠ¶æ€æ›´æ–°ï¼‰
      this. totalFocusCount = allRecords.length;
      console. log(`æ€»æ¬¡æ•°æ›´æ–°ä¸º:  ${this.totalFocusCount}`);

      // 3. åˆ†ç¦»å®Œæˆå’Œæœªå®Œæˆè®°å½•
      const completedRecords = allRecords.filter(r => r.completed === 1);
      const uncompletedRecords = allRecords.filter(r => r.completed === 0);

      // ç«‹å³æ›´æ–°çŠ¶æ€
      this.completedCount = completedRecords.length;
      this. uncompletedCount = uncompletedRecords.length;

      console.log(`å®Œæˆ: ${this.completedCount}, æœªå®Œæˆ: ${this. uncompletedCount}`);

      // 4. è®¡ç®—å®Œæˆç‡ï¼ˆè§¦å‘çŠ¶æ€æ›´æ–°ï¼‰
      if (this.totalFocusCount > 0) {
        this.completionRate = Math.round((this.completedCount / this.totalFocusCount) * 100);
      }
      console.log(`å®Œæˆç‡:  ${this.completionRate}%`);

      // 5. è®¡ç®—æ€»ä¸“æ³¨æ—¶é•¿ï¼ˆåªç»Ÿè®¡å®Œæˆçš„ï¼‰
      if (completedRecords.length > 0) {
        let sum = 0;
        for (let record of completedRecords) {
          sum += record.duration;
        }
        this. totalDuration = sum;
      }
      console.log(`æ€»æ—¶é•¿æ›´æ–°ä¸º: ${this.totalDuration}ç§’`);

      // 6. è®¡ç®—å¹³å‡ä¸“æ³¨æ—¶é•¿ï¼ˆåªç»Ÿè®¡å®Œæˆçš„ï¼‰
      if (completedRecords.length > 0) {
        this.averageDuration = Math.floor(this.totalDuration / completedRecords.length);
      }
      console.log(`å¹³å‡æ—¶é•¿æ›´æ–°ä¸º: ${this.averageDuration}ç§’`);

      // 7. æ‰¾å‡ºæœ€é•¿ä¸“æ³¨æ—¶é•¿ï¼ˆåªç»Ÿè®¡å®Œæˆçš„ï¼‰
      if (completedRecords.length > 0) {
        let maxDuration = 0;
        for (let record of completedRecords) {
          if (record.duration > maxDuration) {
            maxDuration = record.duration;
          }
        }
        this.longestDuration = maxDuration;
      }
      console.log(`æœ€é•¿è®°å½•æ›´æ–°ä¸º: ${this. longestDuration}ç§’`);

      // 8. è·å–ä»Šæ—¥ä¸“æ³¨æ¬¡æ•°ï¼ˆåªç»Ÿè®¡å®Œæˆçš„ï¼‰
      this.todayFocusCount = await FocusRecordDao.getTodayFocusCount(this.userID);
      console.log(`ä»Šæ—¥ä¸“æ³¨æ›´æ–°ä¸º: ${this.todayFocusCount}æ¬¡`);

      // 9. è·å–æœ€è¿‘5æ¡è®°å½•ï¼ˆåˆ›å»ºæ–°æ•°ç»„è§¦å‘æ›´æ–°ï¼‰
      this.recentRecords = allRecords.slice(0, 5);
      console.log(`æœ€è¿‘è®°å½•æ•°:  ${this.recentRecords. length}`);

      // å¼ºåˆ¶æ‰“å°æ‰€æœ‰çŠ¶æ€å˜é‡ï¼Œç¡®è®¤æ›´æ–°
      console.log('=== æœ€ç»ˆçŠ¶æ€ ===');
      console.log(`totalFocusCount: ${this. totalFocusCount}`);
      console.log(`completedCount: ${this.completedCount}`);
      console.log(`uncompletedCount: ${this. uncompletedCount}`);
      console.log(`completionRate: ${this.completionRate}%`);
      console.log(`totalDuration: ${this.totalDuration}ç§’`);
      console.log(`averageDuration: ${this.averageDuration}ç§’`);
      console.log(`longestDuration: ${this.longestDuration}ç§’`);
      console.log(`todayFocusCount: ${this.todayFocusCount}æ¬¡`);
      console.log('================');

      console.log(`ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ`);
      //========ä¿®æ”¹ end========

    } catch (err) {
      console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', err);
      // å‡ºé”™æ—¶é‡ç½®æ‰€æœ‰æ•°æ®ä¸º0
      this.totalDuration = 0;
      this.todayFocusCount = 0;
      this.totalFocusCount = 0;
      this.completedCount = 0;
      this.uncompletedCount = 0;
      this.completionRate = 0;
      this.averageDuration = 0;
      this.longestDuration = 0;
      this.recentRecords = [];
    }
  }
  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæ—¶åˆ†ï¼‰
  formatTimeOnly(dateStr: string): string {
    if (!dateStr || dateStr.length < 16) return '--:--';
    return dateStr.substring(11, 16);
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDateOnly(dateStr:  string): string {
    if (! dateStr || dateStr.length < 10) return '--/--';
    return dateStr.substring(5, 10); // MM-DD
  }
  //========add end========

  build() {
    NavDestination(){
      //========add start========
      Scroll() {
        Column({ space: 15 }) {
          // æ ‡é¢˜åŒºåŸŸ
          Text(this.name + 'çš„ä¸“æ³¨åˆ†æ')
            .fontSize(26)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.normalBGColor)
            .margin({ top: 20, bottom:  10 })

          // æ ¸å¿ƒç»Ÿè®¡å¡ç‰‡
          Grid() {
            // æ€»ä¸“æ³¨æ—¶é•¿
            GridItem() {
              Column() {
                Text('ğŸ“Š')
                  .fontSize(32)
                  .margin({ bottom: 8 })
                Text(this.formatDurationShort(this.totalDuration))
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.normalBGColor)
                Text('æ€»ä¸“æ³¨æ—¶é•¿')
                  . fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 5 })
              }
              . width('100%')
              .padding(20)
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
              .shadow({
                radius: 10,
                color: '#1F000000',
                offsetX: 0,
                offsetY: 3
              })
            }

            // ä»Šæ—¥ä¸“æ³¨æ¬¡æ•°
            GridItem() {
              Column() {
                Text('ğŸ”¥')
                  .fontSize(32)
                  .margin({ bottom: 8 })
                Text(`${this.todayFocusCount}`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  . fontColor('#FF6B6B')
                Text('ä»Šæ—¥ä¸“æ³¨')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 5 })
              }
              .width('100%')
              .padding(20)
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
              .shadow({
                radius: 10,
                color:  '#1F000000',
                offsetX: 0,
                offsetY: 3
              })
            }

            // å®Œæˆç‡
            GridItem() {
              Column() {
                Text('âœ…')
                  . fontSize(32)
                  . margin({ bottom: 8 })
                Text(`${this.completionRate}%`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#4CAF50')
                Text('å®Œæˆç‡')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 5 })
              }
              .width('100%')
              .padding(20)
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
              .shadow({
                radius: 10,
                color: '#1F000000',
                offsetX:  0,
                offsetY:  3
              })
            }

            // æ€»ä¸“æ³¨æ¬¡æ•°
            GridItem() {
              Column() {
                Text('ğŸ“ˆ')
                  .fontSize(32)
                  .margin({ bottom: 8 })
                Text(`${this.totalFocusCount}`)
                  .fontSize(24)
                  . fontWeight(FontWeight.Bold)
                  .fontColor('#9C27B0')
                Text('æ€»ä¸“æ³¨æ¬¡æ•°')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 5 })
              }
              .width('100%')
              .padding(20)
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
              .shadow({
                radius: 10,
                color: '#1F000000',
                offsetX: 0,
                offsetY: 3
              })
            }
          }
          .columnsTemplate('1fr 1fr')
          .rowsTemplate('1fr 1fr')
          .rowsGap(15)
          .columnsGap(15)
          .width('90%')
          .height(320)

          // è¯¦ç»†ç»Ÿè®¡åŒºåŸŸ
          Column({ space: 10 }) {
            Text('è¯¦ç»†ç»Ÿè®¡')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.normalBGColor)
              .alignSelf(ItemAlign.Start)
              .margin({ left: 20, top: 10 })

            // ç»Ÿè®¡åˆ—è¡¨
            Column() {
              Row() {
                Text('âœ“')
                  .width(24)
                  .fontColor('#4CAF50')
                  .margin({ right: 15 })

                Column({ space: 3 }) {
                  Text('å®Œæˆæ¬¡æ•°')
                    .fontSize(14)
                    .fontColor('#666666')
                  Text(this.completedCount+'')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                }
                .alignItems(HorizontalAlign.Start)

                Blank()
              }
              .width('100%')
              .padding({ top: 10, bottom: 10 })
              // this.StatisticItem('å®Œæˆæ¬¡æ•°', `${}æ¬¡`, 'âœ“', '#4CAF50')
              Divider().color('#F0F0F0')
              Row() {
                Text('â—‹')
                  .width(24)
                  .fontColor('#FF9800')
                  .margin({ right: 15 })

                Column({ space: 3 }) {
                  Text('æœªå®Œæˆæ¬¡æ•°')
                    .fontSize(14)
                    .fontColor('#666666')
                  Text(this.uncompletedCount+'')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                }
                .alignItems(HorizontalAlign.Start)

                Blank()
              }
              .width('100%')
              .padding({ top: 10, bottom: 10 })

              Divider().color('#F0F0F0')
              Row() {
                Text('â±')
                  .width(24)
                  .fontColor('#018f8f')
                  .margin({ right: 15 })

                Column({ space: 3 }) {
                  Text('å¹³å‡æ—¶é•¿')
                    .fontSize(14)
                    .fontColor('#666666')
                  Text(this.formatDuration(this.averageDuration)+'')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                }
                .alignItems(HorizontalAlign.Start)

                Blank()
              }
              .width('100%')
              .padding({ top: 10, bottom: 10 })
              Divider().color('#F0F0F0')
              Row() {
                Text('ğŸ†')
                  .width(24)
                  .fontColor('#FFD700')
                  .margin({ right: 15 })

                Column({ space: 3 }) {
                  Text('æœ€é•¿è®°å½•')
                    .fontSize(14)
                    .fontColor('#666666')
                  Text(this.formatDuration(this.longestDuration)+'')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                }
                .alignItems(HorizontalAlign.Start)

                Blank()
              }
              .width('100%')
              .padding({ top: 10, bottom: 10 })
            }
            .width('90%')
            .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
            .borderRadius(15)
            .padding(15)
            .shadow({
              radius: 10,
              color: '#1F000000',
              offsetX: 0,
              offsetY: 3
            })
          }
          .width('100%')

          // æœ€è¿‘è®°å½•
          Column({ space: 10 }) {
            Text('æœ€è¿‘è®°å½•')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.normalBGColor)
              .alignSelf(ItemAlign.Start)
              .margin({ left: 20, top: 10 })

            if (this.recentRecords. length === 0) {
              Column() {
                Text('æš‚æ— è®°å½•')
                  . fontSize(14)
                  .fontColor('#999999')
              }
              .width('90%')
              .height(100)
              .justifyContent(FlexAlign.Center)
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
            } else {
              Column() {
                ForEach(this.recentRecords, (record: FocusRecord, index: number) => {
                  Column() {
                    Row() {
                      Column({ space: 5 }) {
                        Text(`${this.formatDateOnly(record.begin_time)} ${this.formatTimeOnly(record.begin_time)}`)
                          .fontSize(14)
                          . fontColor('#333333')
                        Text(record.getDurationString())
                          .fontSize(12)
                          .fontColor('#666666')
                      }
                      .alignItems(HorizontalAlign.Start)

                      Blank()

                      Text(record.completed === 1 ? 'âœ“' : 'â—‹')
                        .fontSize(18)
                        .fontColor(record.completed === 1 ? '#4CAF50' :  '#FF9800')
                        .padding(8)
                        .borderRadius(20)
                        .backgroundColor(record.completed === 1 ? '#E8F5E9' : '#FFF3E0')
                    }
                    .width('100%')
                    .padding(12)

                    if (index < this.recentRecords.length - 1) {
                      Divider().color('#F0F0F0')
                    }
                  }
                })
              }
              .width('90%')
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
              .shadow({
                radius: 10,
                color: '#1F000000',
                offsetX: 0,
                offsetY: 3
              })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })
          Column({ space: 10 }) {
            Text('AIåˆ†æ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.normalBGColor)
              .alignSelf(ItemAlign.Start)
              .margin({ left: 20, top: 10 })

            if (this.recentRecords. length === 0) {
              Column() {
                Text('è¯·å…ˆä¸“æ³¨æ‰æœ‰åˆ†æå™¢ï¼')
                  . fontSize(14)
                  .fontColor('#999999')
              }
              .width('90%')
              .height(100)
              .justifyContent(FlexAlign.Center)
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
            } else {
              Column() {

                  Column() {
                    Row() {
                      Column({ space: 5 }) {
                        Text('ä»ä»Šå¤©çš„ä¸“æ³¨æ•°æ®æ¥çœ‹ï¼Œä½ çš„ä¸“æ³¨æƒ…å†µè¿˜æœ‰å¾ˆå¤§çš„æå‡ç©ºé—´ã€‚æ€»æ—¶é•¿ä»…æœ‰10ç§’ï¼Œä»Šæ—¥ä¸“æ³¨æ¬¡æ•°ä¸º1æ¬¡ï¼Œè™½ç„¶å®Œæˆç‡ä¸º50%ï¼Œä½†è¿™è¡¨æ˜ä½ è‡³å°‘å¼€å§‹äº†ä¸€æ¬¡ä¸“æ³¨å°è¯•ã€‚ä»è¯¦ç»†ç»Ÿè®¡æ¥çœ‹ï¼Œå®Œæˆå’Œæœªå®Œæˆæ¬¡æ•°å„ä¸º1æ¬¡ï¼Œå¹³å‡æ—¶é•¿å’Œæœ€é•¿è®°å½•å‡ä¸º10ç§’ï¼Œè¯´æ˜è¿™æ¬¡ä¸“æ³¨è¿‡ç¨‹å¯èƒ½æ¯”è¾ƒçŸ­æš‚ï¼Œæœªèƒ½æŒç»­æ·±å…¥ã€‚å»ºè®®å¯ä»¥å°è¯•è®¾å®šæ›´æ˜ç¡®çš„å°ç›®æ ‡ï¼Œé€æ­¥å»¶é•¿æ¯æ¬¡ä¸“æ³¨çš„æ—¶é—´ï¼ŒåŸ¹å…»æ›´ç¨³å®šçš„ä¸“æ³¨ä¹ æƒ¯ã€‚åªè¦åšæŒè®°å½•å’Œè°ƒæ•´ï¼Œä¸“æ³¨åŠ›ä¼šé€æ¸æ”¹å–„çš„ï¼Œç»§ç»­åŠ æ²¹ï¼')
                      }
                      .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .padding(12)

                  }

              }
              .width('90%')
              .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
              .borderRadius(15)
              .shadow({
                radius: 10,
                color: '#1F000000',
                offsetX: 0,
                offsetY: 3
              })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .scrollBar(BarState.Auto)
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
      //========add end========
    }
    .onReady((contextNav:  NavDestinationContext)=>{
      this.pathInfos=contextNav.pathStack;
    })
    //========add start========
    .onShown(() => {
      // é¡µé¢æ˜¾ç¤ºæ—¶åŠ è½½ç»Ÿè®¡æ•°æ®
      console.log('Analyseé¡µé¢æ˜¾ç¤ºï¼Œå¼€å§‹åŠ è½½æ•°æ®');
      this.loadStatistics();
    })
    .title('ä¸“æ³¨åˆ†æ', { backgroundColor: this.normalBGColor })
    //========add end========
  }

  //========add start========
  // ç»Ÿè®¡é¡¹ç»„ä»¶
  @Builder
  StatisticItem(label: string, value: string, icon: string, iconColor: ResourceColor) {
    Row() {
      Text(icon)
        .fontSize(24)
        .fontColor(iconColor)
        .margin({ right: 15 })

      Column({ space: 3 }) {
        Text(label)
          .fontSize(14)
          .fontColor('#666666')
        Text(value)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .alignItems(HorizontalAlign.Start)

      Blank()
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
  }
  //========add end========
}
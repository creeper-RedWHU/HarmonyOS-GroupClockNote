import { text } from "@kit.ArkGraphics2D";
import { AlphabetIndexerModifier } from "@kit.ArkUI";
import { UICountdown, Controller } from '@hw-agconnect/ui-countdown';
//========add start========
import { FocusRecord } from './Entities/RecordOFocus';
import { FocusRecordDao } from './database'
import { promptAction } from '@kit.ArkUI';
//========add end========

//========add start========
// è‡ªå®šä¹‰å€’è®¡æ—¶è¾“å…¥å¯¹è¯æ¡†
@CustomDialog
struct TimeInputDialog {
  controller: CustomDialogController
  cancel: () => void = () => {}
  confirm: (minute: number, second: number) => void = () => {}
  @State inputMinute: string = '25'
  @State inputSecond: string = '0'

  // é™åˆ¶è¾“å…¥èŒƒå›´ 0-59
  validateInput(value: string): number {
    let num = parseInt(value) || 0
    if (num < 0) num = 0
    if (num >= 60) num = 59
    return num
  }

  build() {
    Column({ space: 20 }) {
      Text('è®¾ç½®ä¸“æ³¨æ—¶é•¿')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)

      Row({ space: 10 }) {
        Column() {
          Text('åˆ†é’Ÿ')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 5 })
          TextInput({ placeholder: '0-59', text: this.inputMinute })
            .type(InputType.Number)
            .maxLength(2)
            .width(100)
            .onChange((value:  string) => {
              this. inputMinute = value
            })
        }

        Column() {
          Text('ç§’')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 5 })
          TextInput({ placeholder: '0-59', text: this.inputSecond })
            .type(InputType.Number)
            .maxLength(2)
            .width(100)
            .onChange((value: string) => {
              this.inputSecond = value
            })
        }
      }
      .justifyContent(FlexAlign.Center)

      Text('(åˆ†é’Ÿå’Œç§’æ•°å‡ä¸è¶…è¿‡59)')
        .fontSize(12)
        .fontColor('#999999')

      Flex({ justifyContent: FlexAlign.SpaceAround }) {
        Button('å–æ¶ˆ')
          .onClick(() => {
            this.controller.close()
            this.cancel()
          })
          .backgroundColor('#f0f0f0')
          .fontColor('#333333')
          .width(120)

        Button('ç¡®å®š')
          .onClick(() => {
            const minute = this.validateInput(this.inputMinute)
            const second = this.validateInput(this.inputSecond)

            // è‡³å°‘è¦æœ‰1ç§’
            if (minute === 0 && second === 0) {
              promptAction.showToast({
                message: 'æ—¶é•¿è‡³å°‘ä¸º1ç§’',
                duration:  2000
              })
              return
            }

            this.controller.close()
            this.confirm(minute, second)
          })
          .backgroundColor('#018f8f')
          .fontColor(Color.White)
          .width(120)
      }
      .width('100%')
    }
    .padding(20)
  }
}
//========add end========

@Component
export struct Clock{
  pathInfos:  NavPathStack=new NavPathStack();
  name: string='';
  userID: number=0;
  userName: string='';
  normalBGColor:  string='#018f8f';
  normalFontColor: string='#f7fbfb';
  todayFontColor:   string='#ffffff';
  todayBGColor:  string='#32bdc0';
  choiceFontColor: string='#40a9a6';
  choiceBGColor: string='#c6e2e5';

  private controller=new Controller();
  beginText:  string="â–¶ å¼€å§‹ä¸“æ³¨"
  endText: string="â¸ æ”¾å¼ƒä¸“æ³¨"
  beginColor: string="#1596b6";
  endColor:  string="#d01b39";
  beginTimeFontColor: string='#808080';
  endTimeFontColor:string='#10aab0';

  //========add start========
  @State setMinute: number = 0  // åˆ†é’Ÿ
  @State setSecond: number = 0   // ç§’
  //========add end========

  @State buttonColor: string=this.beginColor;
  @State start: boolean=false;
  @State textToShow:string=this.  beginText;
  @State timeFontColor:string=this.  beginTimeFontColor;
  @State animationId: number | null = null
  @State progressValue: number = 100

  beginTime:Date=new Date();
  endTime:Date = new Date();

  //========add start========
  // ä¸“æ³¨è®°å½•åˆ—è¡¨ï¼ˆæ˜¾ç¤ºå·²å®Œæˆå’Œæœªå®Œæˆçš„ï¼‰
  @State focusRecords: FocusRecord[] = [];

  // å€’è®¡æ—¶è¾“å…¥å¯¹è¯æ¡†æ§åˆ¶å™¨
  dialogController: CustomDialogController = new CustomDialogController({
    builder: TimeInputDialog({
      cancel: () => { this.onDialogCancel() },
      confirm: (minute: number, second:  number) => { this.onDialogConfirm(minute, second) }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  })

  onDialogCancel() {
    console.info('ç”¨æˆ·å–æ¶ˆäº†æ—¶é—´è®¾ç½®')
  }

  onDialogConfirm(minute: number, second:  number) {
    console.info(`ç”¨æˆ·è®¾ç½®æ—¶é•¿:  ${minute}åˆ†${second}ç§’`)
    this.setMinute = minute
    this.setSecond = second
    this. totalSeconds = minute * 60 + second

    // å¼€å§‹ä¸“æ³¨
    this.startFocus()
  }
  //========add end========

  formatTimestamp(date: Date) {
    const year = date.  getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hour = date.  getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    const second = date.getSeconds().toString().padStart(2, '0');
    return `${year}-${month}-${day} ${hour}: ${minute}:${second}`;
  }

  //========add start========
  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæ—¶åˆ†ç§’ï¼‰
  formatTimeOnly(dateStr:   string): string {
    return dateStr.substring(11);
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºå¹´æœˆæ—¥ï¼‰
  formatDateOnly(dateStr: string): string {
    return dateStr.substring(0,10);
  }

  // åŠ è½½ä¸“æ³¨è®°å½•ï¼ˆåŠ è½½å·²å®Œæˆå’Œæœªå®Œæˆçš„è®°å½•ï¼‰
  async loadFocusRecords() {
    try {
      // è·å–æ‰€æœ‰è®°å½•
      this.focusRecords = await FocusRecordDao.getFocusRecordByUserId(this.userID);
      console.log(`åŠ è½½äº† ${this.focusRecords. length} æ¡ä¸“æ³¨è®°å½•`);
    } catch (err) {
      console.error('åŠ è½½ä¸“æ³¨è®°å½•å¤±è´¥', err);
    }
  }

  // ä¿å­˜ä¸“æ³¨è®°å½•ï¼ˆcompleted:  1=å®Œæˆ, 0=æœªå®Œæˆï¼‰
  async saveFocusRecord(completed: number) {
    try {
      const beginTimeStr = this.formatTimestamp(this.beginTime);
      const endTimeStr = this.formatTimestamp(this.endTime);
      const duration = Math.floor((this.endTime. getTime() - this.beginTime.getTime()) / 1000);
      if(duration === 0)return;
      await FocusRecordDao.addFocusRecord({
        user_id: this.userID,
        begin_time: beginTimeStr,
        end_time:  endTimeStr,
        duration:  duration,
        completed: completed
      });

      console.log(`ä¸“æ³¨è®°å½•ä¿å­˜æˆåŠŸ(${completed === 1 ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}): ${beginTimeStr} - ${endTimeStr}`);
      // é‡æ–°åŠ è½½è®°å½•
      await this.loadFocusRecords();
    } catch (err) {
      console.error('ä¿å­˜ä¸“æ³¨è®°å½•å¤±è´¥', err);
    }
  }

  // å¼€å§‹ä¸“æ³¨çš„é€»è¾‘
  startFocus() {
    this.buttonColor = this.endColor;
    this.textToShow = this.endText;
    this.timeFontColor = this.endTimeFontColor;
    this.start = true;
    this.beginTime = new Date();

    // æ›´æ–° UICountdown çš„æ—¶é—´
    this.controller.update()

    // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
    if (this.animationId === null) {
      this.animationId = setInterval(() => {
        this.progressValue--
        if (this.progressValue <= 0) {
          // å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨é‡ç½®
          clearInterval(this.animationId)
          this.animationId = null
          this.progressValue = 100
          this.start = false
        }
      }, (this.totalSeconds * 1000) / 100)
    }
  }
  //========add end========

  //========add start========
  // å€’è®¡æ—¶æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  @State totalSeconds: number = 25 * 60
  //========add end========

  build() {
    NavDestination(){
      Column() {
        Toggle({type: ToggleType.Button, isOn: false}){
          Text(this.textToShow)
            .fontColor(this.normalFontColor)
            .fontSize(30)
            .textAlign(TextAlign.Center)
        }. align(Alignment.Center)
        .padding(20)
        .backgroundColor(this.buttonColor)
        .onClick(() => {
          if(this.buttonColor === this.beginColor) {
            //========add start========
            // å¼€å§‹ä¸“æ³¨ - å¼¹å‡ºæ—¶é—´è¾“å…¥å¯¹è¯æ¡†
            this. dialogController.open()
            //========add end========
          } else {
            //========add start========
            // æ”¾å¼ƒä¸“æ³¨ - ä¿å­˜æœªå®Œæˆè®°å½•
            this. buttonColor = this.beginColor;
            this.textToShow = this.beginText;
            this.timeFontColor = this. beginTimeFontColor;
            this.start = false;
            this.endTime = new Date();

            // ä¿å­˜æœªå®Œæˆè®°å½•
            this.saveFocusRecord(0);

            // åœæ­¢è¿›åº¦æ¡åŠ¨ç”»å¹¶é‡ç½®
            if (this.animationId !== null) {
              clearInterval(this.animationId)
              this.animationId = null
            }
            this. progressValue = 100

            // é‡ç½®å€’è®¡æ—¶
            this. controller.update();
            //========add end========
          }
        })
      }
      .width('100%')
      .height('20%')
      .linearGradient({
        direction: GradientDirection.Top,
        colors: [
          [this.todayBGColor, 0.0],
          [this.normalBGColor, 1.0]
        ]
      })

      Row(){
        UICountdown({
          showDay: false,
          showHour: false,
          minute: `${this.setMinute}`,
          second: `${this.setSecond}`,
          start: this.start,
          controller: this.controller,
          timeColor: this.timeFontColor,
          fontSize: 60,
          timeup: () => {
            // å€’è®¡æ—¶ç»“æŸï¼Œåœæ­¢è¿›åº¦æ¡åŠ¨ç”»
            if (this.animationId !== null) {
              clearInterval(this. animationId)
              this. animationId = null
            }
            this.progressValue = 100
            this.start = false
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            this.buttonColor = this.beginColor
            this.textToShow = this.beginText
            this.timeFontColor = this.beginTimeFontColor
            console.log('å€’è®¡æ—¶ç»“æŸ')
            this.endTime = new Date();

            //========add start========
            // ä¿å­˜å·²å®Œæˆè®°å½•
            this.saveFocusRecord(1);
            //========add end========
          }
        })
          .padding('6%')
      }
      .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
      .height('20%')
      .alignItems(VerticalAlign.Center)
      .margin({ left: '15%' })
      .justifyContent(FlexAlign.Center)

      Progress({ value: 0, total: 100, type: ProgressType.Ring })
        .color(this.normalBGColor)
        .value(this.progressValue)
        .width(200)
        .style({
          strokeWidth: 10,
          scaleCount: 20,
          scaleWidth: 5,
          enableSmoothEffect: true
        })
        .backgroundColor(Color.White)
        .rotate({
          x: 0,
          y: 1,
          z: 0,
          centerX: '50%',
          centerY:  '50%',
          angle:  180
        })

      //========add start========
      // ä¸“æ³¨è®°å½•åˆ—è¡¨åŒºåŸŸï¼ˆæ˜¾ç¤ºå·²å®Œæˆå’Œæœªå®Œæˆçš„è®°å½•ï¼‰
      Column() {
        Text(this.userName + 'çš„ä¸“æ³¨è®°å½•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center)
          .margin({ top: 20, bottom: 15 })
          .fontColor(this.choiceFontColor)

        if (this.focusRecords. length === 0) {
          // ç©ºçŠ¶æ€æç¤º
          Column() {
            Text('ğŸ“')
              .fontSize(48)
              .margin({ bottom: 10 })
            Text('æš‚æ— ä¸“æ³¨è®°å½•')
              .fontSize(16)
              .fontColor('#999999')
            Text('å®Œæˆä¸€æ¬¡ä¸“æ³¨åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ')
              .fontSize(12)
              .fontColor('#CCCCCC')
              .margin({ top: 5 })
          }
          .justifyContent(FlexAlign.Center)
          .height(200)
        } else {
          // ä½¿ç”¨ Grid ç»„ä»¶å±•ç¤ºè®°å½•
          Grid() {
            ForEach(this.focusRecords, (record: FocusRecord, index: number) => {
              GridItem() {
                Column() {
                  // æ—¥æœŸæ˜¾ç¤º
                  Text(this. formatDateOnly(record.begin_time))
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ bottom: 8 })

                  // æ—¶é—´èŒƒå›´
                  Row() {
                    Text(this.formatTimeOnly(record.begin_time))
                      .fontSize(14)
                      .fontColor(this.normalBGColor)
                      .fontWeight(FontWeight.Medium)
                    Text(' â†’ ')
                      .fontSize(12)
                      .fontColor('#999999')
                    Text(this.formatTimeOnly(record.end_time))
                      .fontSize(14)
                      .fontColor(this.normalBGColor)
                      . fontWeight(FontWeight.Medium)
                  }
                  . justifyContent(FlexAlign. Center)
                  .margin({ bottom: 8 })

                  // æ—¶é•¿æ˜¾ç¤º
                  Text(record.getDurationString())
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(record.isCompleted() ? this.todayBGColor : '#FF9800')
                    .margin({ bottom: 8 })

                  // å®ŒæˆçŠ¶æ€æ ‡ç­¾
                  Text(record.isCompleted() ? 'âœ“ å·²å®Œæˆ' : 'â—‹ æœªå®Œæˆ')
                    .fontSize(12)
                    .fontColor(Color.White)
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .borderRadius(10)
                    .backgroundColor(record.isCompleted() ? this.todayBGColor : '#FF9800')
                }
                .width('100%')
                .padding(15)
                .backgroundColor($r('sys.color.ohos_id_color_list_card_bg'))
                .borderRadius(12)
                .shadow({
                  radius: 8,
                  color: '#1F000000',
                  offsetX:  0,
                  offsetY: 2
                })
              }
              .padding(8)
            })
          }
          .columnsTemplate('1fr 1fr') // ä¸¤åˆ—å¸ƒå±€
          .rowsGap(10)
          .columnsGap(10)
          .width('95%')
          .height(300)
          .scrollBar(BarState.Auto)
        }
      }
      .width('100%')
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      //========add end========

    }
    .onReady((contextNav: NavDestinationContext) => {
      this.pathInfos = contextNav.pathStack;
    })
    .title('ä¸“æ³¨æ—¶é’Ÿ', {backgroundColor: this.normalBGColor})
    .onShown(async () => {
      //========add start========
      // é¡µé¢æ˜¾ç¤ºæ—¶åŠ è½½ä¸“æ³¨è®°å½•
      await this.loadFocusRecords();
      //========add end========
    })
  }
}